<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Depot Dashboard Live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; }
  h1 { font-size: 20px; }
  #sections { display:flex; gap:20px; flex-wrap:wrap; margin-top:20px; }
  .card { border:1px solid #ccc; border-radius:6px; padding:12px; min-width:220px; background:#fafafa; }
  .ok { color:green; }
  .warn { color:red; }
  #map { margin-top:20px; height:420px; }
</style>
</head>
<body>
<h1>Depot Dashboard – Live Zones</h1>
<div id="status">Loading…</div>
<div id="sections"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* === CONFIG === */
const API_BASE = "https://api.eu.navixy.com/v2"; // or us.navixy.com
const API_KEY  = "39736582e2058803e90919b91fd5e5f9"; // <-- your key
const REFRESH_MS = 30000;
const DWELL_THRESHOLD = 30;   // minutes before red
const LOOKBACK_HOURS = 12;

// Excluded zones
const EXCLUDED_ZONES = [
  "Fuel Stop - Denne Road",
  "Fuel Station - Umlaas 3 Pumps",
  "Route Notify - Durban South"
];

/* === API helper === */
function apiPost(path, body) {
  return fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Authorization": `NVX ${API_KEY}` 
    },
    body: JSON.stringify(body || {})
  }).then(r => r.json());
}

/* === Load trackers and zones === */
async function getTrackers() {
  const res = await apiPost("/tracker/list", {});
  return res.success ? res.list : [];
}
async function getStates(ids) {
  const res = await apiPost("/tracker/get_states", { trackers: ids });
  return res.success ? res.states : {};
}
async function getEvents() {
  const to = new Date();
  const from = new Date(to.getTime() - LOOKBACK_HOURS*3600*1000);
  const fmt = d => d.toISOString().slice(0,19).replace('T',' ');
  const res = await apiPost("/history/user/list", {
    from: fmt(from), to: fmt(to),
    events: ["inzone","outzone"],
    limit: 2000, ascending: true
  });
  return res.success ? res.list : [];
}

/* === Compute current dwell times === */
function computeCurrent(events, states) {
  const now = new Date();
  const insideMap = {}; // trackerId -> {zone, since}

  // 1. Build from latest states (true current presence)
  for (const tid in states) {
    const st = states[tid];
    const zones = st?.gps?.zone_ids || [];
    zones.forEach(zid => {
      const zlabel = st?.gps?.zone_labels?.[zones.indexOf(zid)] || "Unknown";
      if (!EXCLUDED_ZONES.includes(zlabel)) {
        insideMap[tid] = insideMap[tid] || {};
        insideMap[tid][zid] = { since: now, zone: zlabel };
      }
    });
  }

  // 2. Correct entry time using events
  events.forEach(e => {
    const tid = e.tracker_id;
    const zid = e.extra?.zone_ids?.[0];
    const zlabel = e.extra?.zone_labels?.[0];
    if (!zid || !insideMap[tid] || !insideMap[tid][zid]) return;
    if (e.event==="inzone") {
      insideMap[tid][zid].since = new Date(e.time); // use real enter time
    }
  });

  // 3. Convert to zones map
  const zones = {};
  for (const tid in insideMap) {
    for (const zid in insideMap[tid]) {
      const entry = insideMap[tid][zid];
      const mins = Math.round((now - entry.since)/60000);
      zones[entry.zone] = zones[entry.zone] || [];
      zones[entry.zone].push({tid, mins});
    }
  }
  return zones;
}

/* === Format dwell hh:mm === */
function formatTime(mins) {
  const h=Math.floor(mins/60), m=mins%60;
  return h>0 ? `${h}h ${m}m` : `${m}m`;
}

/* === Render sections === */
function renderSections(zones, trackers) {
  const c=document.getElementById("sections"); c.innerHTML="";
  for (const zone in zones) {
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<h3>${zone}</h3>`;
    zones[zone].forEach(t=>{
      const label=trackers.find(x=>x.id==t.tid)?.label||"#"+t.tid;
      const cls=t.mins>DWELL_THRESHOLD?"warn":"ok";
      div.innerHTML+=`<div class="${cls}">${label}: ${formatTime(t.mins)}</div>`;
    });
    c.appendChild(div);
  }
}

/* === Render map (only inside zones) === */
let map, markers=[];
function renderMap(states, trackers, zones) {
  if (!map) {
    map=L.map("map").setView([0,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const bounds=[];
  for (const zone in zones) {
    zones[zone].forEach(t=>{
      const loc=states[t.tid]?.gps?.location;
      if (!loc) return;
      const label=trackers.find(x=>x.id==t.tid)?.label||"#"+t.tid;
      const color=t.mins>DWELL_THRESHOLD?"red":"green";
      const icon=L.divIcon({className:"", html:`<div style="background:${color};width:12px;height:12px;border-radius:50%"></div>`});
      const m=L.marker([loc.lat,loc.lng],{icon}).addTo(map).bindPopup(`${label}<br>${formatTime(t.mins)}`);
      markers.push(m); bounds.push([loc.lat,loc.lng]);
    });
  }
  if (bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

/* === Update === */
async function update() {
  const s=document.getElementById("status");
  try {
    s.textContent="Updating…";
    const trackers=await getTrackers();
    const states=await getStates(trackers.map(t=>t.id));
    const events=await getEvents();
    const zones=computeCurrent(events, states);
    renderSections(zones, trackers);
    renderMap(states, trackers, zones);
    s.textContent=`Updated at ${new Date().toLocaleTimeString()}`;
  } catch(err) {
    console.error(err); s.textContent="Error: "+err;
  }
}
update(); setInterval(update,REFRESH_MS);
</script>
</body>
</html>
