<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Depot Dashboard Live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f6f8; }
  h1 { font-size: 22px; margin-bottom: 10px; }
  #status { font-size: 14px; color:#444; margin-bottom:10px; }
  #sections { display:flex; gap:20px; flex-wrap:wrap; margin-top:10px; }
  .card { background:white; border:1px solid #ddd; border-radius:10px; padding:14px; min-width:220px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  .card h3 { margin:0 0 8px; font-size:16px; color:#333; }
  .truck { display:flex; justify-content:space-between; padding:6px 0; border-top:1px dashed #eee; font-weight:500; }
  .truck:first-of-type { border-top:none; }
  .ok { color:green; }
  .warn { color:red; }
  #map { margin-top:20px; height:450px; border-radius:10px; border:1px solid #ccc; }
</style>
</head>
<body>
<h1>Depot Dashboard – Live Zones</h1>
<div id="status">Loading…</div>
<div id="sections"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* === CONFIG === */
const API_BASE = "https://api.eu.navixy.com/v2"; // or us.navixy.com if account is US
const API_KEY  = "39736582e2058803e90919b91fd5e5f9"; // your key
const REFRESH_MS = 30000;
const DWELL_THRESHOLD = 30; // minutes
const LOOKBACK_HOURS = 24;
const EXCLUDED_ZONES = [
  "Fuel Stop - Denne Road",
  "Fuel Station - Umlaas 3 Pumps",
  "Route Notify - Durban South"
];

/* === API helper === */
function apiPost(path, body) {
  return fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `NVX ${API_KEY}` },
    body: JSON.stringify(body || {})
  }).then(r => r.json());
}

/* === Data fetchers === */
async function getTrackers() {
  const res = await apiPost("/tracker/list", {});
  return res.success ? res.list : [];
}
async function getStates(ids) {
  const res = await apiPost("/tracker/get_states", { trackers: ids });
  return res.success ? res.states : {};
}
async function getEvents() {
  const to = new Date();
  const from = new Date(to.getTime() - LOOKBACK_HOURS*3600*1000);
  const fmt = d => d.toISOString().slice(0,19).replace('T',' ');
  const res = await apiPost("/history/user/list", {
    from: fmt(from), to: fmt(to),
    events: ["inzone"],
    limit: 2000, ascending: true
  });
  return res.success ? res.list : [];
}

/* === Dwell computation === */
function computeCurrent(states, events) {
  const now=new Date();
  const latestEnter={}; // tracker+zone -> time
  events.forEach(e=>{
    const tid=e.tracker_id;
    const zid=e.extra?.zone_ids?.[0];
    const zlabel=e.extra?.zone_labels?.[0];
    if (!zid || EXCLUDED_ZONES.includes(zlabel)) return;
    const key=`${tid}_${zid}`;
    latestEnter[key]=new Date(e.time);
  });

  const zones={};
  for (const tid in states) {
    const st=states[tid];
    const zoneIds=st?.gps?.zone_ids||[];
    const zoneLabels=st?.gps?.zone_labels||[];
    zoneIds.forEach((zid,i)=>{
      const zlabel=zoneLabels[i]||"Unknown";
      if (EXCLUDED_ZONES.includes(zlabel)) return;
      const key=`${tid}_${zid}`;
      const since=latestEnter[key]||now;
      const mins=Math.round((now-since)/60000);
      zones[zlabel]=zones[zlabel]||[];
      zones[zlabel].push({tid,mins});
    });
  }
  return zones;
}

/* === Formatting === */
function formatTime(mins) {
  const h=Math.floor(mins/60), m=mins%60;
  return h>0?`${h}h ${m}m`:`${m}m`;
}

/* === Rendering === */
function renderSections(zones, trackers) {
  const c=document.getElementById("sections"); c.innerHTML="";
  for (const zone in zones) {
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`<h3>${zone}</h3>`;
    zones[zone].forEach(t=>{
      const label=trackers.find(x=>x.id==t.tid)?.label||"#"+t.tid;
      const cls=t.mins>DWELL_THRESHOLD?"warn":"ok";
      div.innerHTML+=`<div class="truck ${cls}"><span>${label}</span><span>${formatTime(t.mins)}</span></div>`;
    });
    c.appendChild(div);
  }
}
let map, markers=[];
function renderMap(states, trackers, zones) {
  if (!map) {
    map=L.map("map").setView([0,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const bounds=[];
  for (const zone in zones) {
    zones[zone].forEach(t=>{
      const loc=states[t.tid]?.gps?.location;
      if (!loc) return;
      const label=trackers.find(x=>x.id==t.tid)?.label||"#"+t.tid;
      const color=t.mins>DWELL_THRESHOLD?"red":"green";
      const icon=L.divIcon({className:"", html:`<div style="background:${color};width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,.3)"></div>`});
      const m=L.marker([loc.lat,loc.lng],{icon}).addTo(map).bindPopup(`${label}<br>${formatTime(t.mins)}`);
      markers.push(m); bounds.push([loc.lat,loc.lng]);
    });
  }
  if (bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

/* === Update loop === */
async function update() {
  const s=document.getElementById("status");
  try {
    s.textContent="Updating…";
    const trackers=await getTrackers();
    const states=await getStates(trackers.map(t=>t.id));
    const events=await getEvents();
    const zones=computeCurrent(states,events);
    renderSections(zones,trackers);
    renderMap(states,trackers,zones);
    s.textContent=`Updated at ${new Date().toLocaleTimeString()}`;
  } catch(err) {
    console.error(err); s.textContent="Error: "+err;
  }
}
update(); setInterval(update,REFRESH_MS);
</script>
</body>
</html>
