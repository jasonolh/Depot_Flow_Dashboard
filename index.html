<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Depot Live Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin:0; }
  header { padding: 12px 16px; border-bottom: 1px solid #e5e5e5; }
  h1 { font-size: 20px; margin: 0; }
  main { padding: 16px; max-width: 1200px; margin: auto; }
  #status { margin-bottom: 10px; font-size: 14px; color:#444; }
  .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); }
  .card { border: 1px solid #ccc; border-radius: 6px; padding: 12px; background:#fafafa; }
  .card h3 { margin: 0 0 8px; font-size: 16px; }
  .truck { display: flex; justify-content: space-between; font-weight: bold; padding:4px 0; }
  .ok { color: green; }
  .warn { color: red; }
  #map { height: 420px; margin-top: 16px; border-radius: 6px; border:1px solid #ddd; }
</style>
</head>
<body>
<header>
  <h1>Depot Live Dashboard</h1>
</header>
<main>
  <div id="status">Loading…</div>
  <div class="grid" id="sections"></div>
  <div id="map"></div>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* CONFIG */
const API_BASE = "https://api.eu.navixy.com/v2"; // change to us.navixy.com if needed
const REFRESH_MS = 30000;
const DWELL_THRESHOLD_MIN = 30;
const LOOKBACK_HOURS = 48;

const qs = new URLSearchParams(location.search);
const HASH = qs.get("session_key");
if (!HASH) console.warn("No session_key in URL. Make sure Navixy passes it.");

// API call helper
function apiPost(path, body) {
  return fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `NVX ${HASH}`
    },
    body: JSON.stringify(body || {})
  }).then(r => r.json());
}

// Load trackers
async function getTrackers() {
  const res = await apiPost("/tracker/list", {});
  if (!res.success) throw new Error("tracker/list failed");
  return res.list.map(t => ({ id: t.id, label: t.label || t.name || `#${t.id}` }));
}

// Load last states
async function getStates(ids) {
  if (!ids.length) return {};
  const res = await apiPost("/tracker/get_states", { trackers: ids });
  if (!res.success) throw new Error("tracker/get_states failed");
  return res.states || {};
}

// Load geofence events
async function getEvents() {
  const to = new Date();
  const from = new Date(to.getTime() - LOOKBACK_HOURS * 3600 * 1000);
  const fmt = d => d.toISOString().slice(0,19).replace('T',' ');
  const res = await apiPost("/history/user/list", {
    from: fmt(from), to: fmt(to),
    events: ["inzone","outzone"],
    limit: 1000, ascending: true
  });
  if (!res.success) throw new Error("history/user/list failed");
  return res.list || [];
}

// Compute dwell times
function computeDwell(events) {
  const inside = {};
  const zones = {};
  events.sort((a,b)=> new Date(a.time)-new Date(b.time));
  for (const e of events) {
    const tid = e.tracker_id;
    const when = new Date(e.time);
    const zid = e.extra?.zone_ids?.[0];
    const zlabel = e.extra?.zone_labels?.[0] || "Unknown";
    if (!zid) continue;
    inside[tid] = inside[tid] || {};
    if (e.event==="inzone") inside[tid][zid] = { since: when, zlabel };
    else if (e.event==="outzone") delete inside[tid][zid];
  }
  const now = new Date();
  for (const tid in inside) {
    for (const zid in inside[tid]) {
      const entry = inside[tid][zid];
      const mins = Math.round((now - entry.since)/60000);
      zones[entry.zlabel] = zones[entry.zlabel] || [];
      zones[entry.zlabel].push({ tid, since: entry.since, mins });
    }
  }
  return zones;
}

// Render dashboard
function renderSections(zones, lookup) {
  const c = document.getElementById("sections");
  c.innerHTML="";
  if (!Object.keys(zones).length) {
    c.innerHTML="<div class='card'><h3>No trucks in depot</h3></div>";
    return;
  }
  for (const name of Object.keys(zones)) {
    const list = zones[name];
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML=`<h3>${name} (${list.length})</h3>`;
    list.forEach(t=>{
      const label=lookup[t.tid]?.label||`#${t.tid}`;
      const cls = t.mins>DWELL_THRESHOLD_MIN?"warn":"ok";
      div.innerHTML+=`<div class="truck ${cls}"><span>${label}</span><span>${t.mins} min</span></div>`;
    });
    c.appendChild(div);
  }
}

// Render map
let map, markers=[];
function renderMap(states, lookup) {
  if (!map) {
    map=L.map("map").setView([0,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  const bounds=[];
  for (const tid in states) {
    const gps=states[tid]?.gps;
    if (!gps?.location) continue;
    const label=lookup[tid]?.label||`#${tid}`;
    const m=L.marker([gps.location.lat,gps.location.lng]).addTo(map).bindPopup(label);
    markers.push(m); bounds.push([gps.location.lat,gps.location.lng]);
  }
  if (bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

// Update loop
async function update() {
  const status=document.getElementById("status");
  try {
    status.textContent="Updating…";
    const trackers=await getTrackers();
    const lookup=Object.fromEntries(trackers.map(t=>[t.id,t]));
    const events=await getEvents();
    const zones=computeDwell(events);
    renderSections(zones,lookup);
    const states=await getStates(trackers.map(t=>t.id));
    renderMap(states,lookup);
    status.textContent=`Updated ${new Date().toLocaleTimeString()}`;
  } catch(err) {
    console.error(err); status.textContent="Error loading data";
  }
}
update(); setInterval(update,REFRESH_MS);
</script>
</body>
</html>
