<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Depot Dashboard Test</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; }
  h1 { font-size: 20px; }
  #sections { display:flex; gap:20px; flex-wrap:wrap; margin-top:20px; }
  .card { border:1px solid #ccc; border-radius:6px; padding:12px; min-width:200px; background:#fafafa; }
  .ok { color:green; }
  .warn { color:red; }
  #map { margin-top:20px; height:400px; }
</style>
</head>
<body>
<h1>Depot Dashboard (PlayCode test)</h1>
<div id="status">Loading…</div>
<div id="sections"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* === CONFIG === */
const API_BASE = "https://api.eu.navixy.com/v2"; // or us.navixy.com if your account is US
const API_KEY  = "39736582e2058803e90919b91fd5e5f9"; // <-- your real key
const REFRESH_MS = 30000;
const DWELL_THRESHOLD = 30;   // minutes before warning
const LOOKBACK_HOURS = 24;

// Excluded zones
const EXCLUDED_ZONES = [
  "Fuel Stop - Denne Road",
  "Fuel Station - Umlaas 3 Pumps",
  "Route Notify - Durban South"
];

/* === API helper === */
function apiPost(path, body) {
  return fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Authorization": `NVX ${API_KEY}` 
    },
    body: JSON.stringify(body || {})
  }).then(r => r.json());
}

/* === Load trackers === */
async function getTrackers() {
  const res = await apiPost("/tracker/list", {});
  return res.success ? res.list : [];
}

/* === Load last positions === */
async function getStates(ids) {
  const res = await apiPost("/tracker/get_states", { trackers: ids });
  return res.success ? res.states : {};
}

/* === Load geofence events === */
async function getEvents() {
  const to = new Date();
  const from = new Date(to.getTime() - LOOKBACK_HOURS*3600*1000);
  const fmt = d => d.toISOString().slice(0,19).replace('T',' ');
  const res = await apiPost("/history/user/list", {
    from: fmt(from), to: fmt(to),
    events: ["inzone","outzone"],
    limit: 1000, ascending: true
  });
  return res.success ? res.list : [];
}

/* === Compute dwell === */
function computeDwell(events) {
  const inside = {}, zones = {};
  events.sort((a,b)=> new Date(a.time)-new Date(b.time));
  for (const e of events) {
    const tid = e.tracker_id;
    const when = new Date(e.time);
    const zid = e.extra?.zone_ids?.[0];
    const zlabel = e.extra?.zone_labels?.[0] || "Unknown";
    if (!zid) continue;
    if (EXCLUDED_ZONES.includes(zlabel)) continue; // skip excluded zones

    inside[tid] = inside[tid] || {};
    if (e.event==="inzone") inside[tid][zid] = { since: when, zlabel };
    else if (e.event==="outzone") delete inside[tid][zid];
  }
  const now=new Date();
  for (const tid in inside) {
    for (const zid in inside[tid]) {
      const entry=inside[tid][zid];
      const mins=Math.round((now-entry.since)/60000);
      zones[entry.zlabel]=zones[entry.zlabel]||[];
      zones[entry.zlabel].push({tid,mins});
    }
  }
  return zones;
}

/* === Format dwell time in hours and minutes === */
function formatTime(totalMinutes) {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  if (h > 0) {
    return `${h}h ${m}m`;
  }
  return `${m}m`;
}

/* === Render sections === */
function renderSections(zones, trackers) {
  const c=document.getElementById("sections"); 
  c.innerHTML="";
  for (const zone in zones) {
    if (EXCLUDED_ZONES.includes(zone)) continue; // skip unwanted zones

    const div=document.createElement("div"); 
    div.className="card";
    div.innerHTML=`<h3>${zone}</h3>`;

    zones[zone].forEach(t=>{
      const label=trackers.find(x=>x.id==t.tid)?.label||"#"+t.tid;
      const cls=t.mins>DWELL_THRESHOLD?"warn":"ok";
      const timeStr=formatTime(t.mins);
      div.innerHTML+=`<div class="${cls}">${label}: ${timeStr}</div>`;
    });
    c.appendChild(div);
  }
}

/* === Render map === */
let map, markers=[];
function renderMap(states, trackers, zones) {
  if (!map) {
    map=L.map("map").setView([0,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const bounds=[];
  for (const tid in states) {
    // only plot trucks currently in included zones
    const inAnyZone = Object.values(zones).some(list => list.some(t => t.tid == tid));
    if (!inAnyZone) continue;

    const loc=states[tid]?.gps?.location; 
    if (!loc) continue;
    const label=trackers.find(x=>x.id==tid)?.label||"#"+tid;
    const m=L.marker([loc.lat,loc.lng]).addTo(map).bindPopup(label);
    markers.push(m); bounds.push([loc.lat,loc.lng]);
  }
  if (bounds.length) map.fitBounds(bounds,{padding:[30,30]});
}

/* === Update loop === */
async function update() {
  const s=document.getElementById("status");
  try {
    s.textContent="Updating…";
    const trackers=await getTrackers();
    const events=await getEvents();
    const zones=computeDwell(events);
    renderSections(zones,trackers);
    const states=await getStates(trackers.map(t=>t.id));
    renderMap(states,trackers,zones);
    s.textContent=`Updated at ${new Date().toLocaleTimeString()}`;
  } catch(err) {
    console.error(err); s.textContent="Error: "+err;
  }
}
update(); setInterval(update,REFRESH_MS);
</script>
</body>
</html>
