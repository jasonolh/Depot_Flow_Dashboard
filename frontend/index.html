<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Depot Dashboard â€“ Live Zones</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root { --card:#fff; --ink:#111; --muted:#667; --line:#e6e8eb; --ok:#1a7f37; --warn:#d92d20; --bg:#f5f7fb; --brand:#1f6feb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial}
    header{padding:14px 18px;border-bottom:1px solid var(--line);background:#fff}
    h1{margin:0;font-size:20px}
    main{max-width:1280px;margin:0 auto;padding:16px}
    .statusbar{display:flex;gap:10px;align-items:center;margin:8px 0 12px;flex-wrap:wrap}
    .badge{border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;color:var(--muted)}
    .btn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .tog{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}
    select{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .truck{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-top:1px dashed var(--line);font-weight:600;cursor:pointer}
    .truck:first-of-type{border-top:none}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    #map{height:520px;border:1px solid var(--line);border-radius:12px;margin-top:16px}
    details.debug{margin-top:14px}
    details.debug summary{cursor:pointer;font-weight:600}
    pre{white-space:pre-wrap;background:#0b1221;color:#e6edf3;padding:12px;border-radius:8px;overflow:auto}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{background:#f7f9ff;color:#334}
    .small{font-size:12px;color:#555}
    tr.warn td{color:var(--warn);font-weight:600}
  </style>
</head>
<body>
  <header><h1>Depot Dashboard â€“ Live Zones</h1></header>
  <main>
    <div class="statusbar">
      <span id="updated" class="badge">Loadingâ€¦</span>
      <label class="tog">Cluster 
        <select id="cluster">
          <option value="eu" selected>EU</option>
          <option value="us">US</option>
        </select>
      </label>
      <label class="tog">Refresh 
        <select id="refreshSelect">
          <option value="30000">30s</option>
          <option value="60000">1m</option>
          <option value="120000">2m</option>
          <option value="180000" selected>3m</option>
          <option value="300000">5m</option>
        </select>
      </label>
      <label class="tog"><input type="checkbox" id="toggleAllZones" /> Use ALL zones</label>
      <label class="tog"><input type="checkbox" id="toggleShowAll" /> Show ALL trackers</label>
      <label class="tog"><input type="checkbox" id="toggleSwapMap" /> Swap Lat/Lon</label>
      <button class="btn primary" id="pickZones">Choose zones</button>
      <button class="btn" id="testBtn">Run once</button>
      <span id="counts" class="badge">â€“</span>
      <span id="groupb" class="badge">Group: â€“</span>
      <span id="authb" class="badge">Auth: â€“</span>
    </div>

    <div id="grid"></div>
    <div id="map"></div>

    <details class="debug" open>
      <summary>Diagnostics</summary>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0">
        <span id="dbg-zones" class="badge">Zones usable: â€“</span>
        <span id="dbg-labels" class="badge">Labeled: â€“</span>
        <span id="dbg-allowed" class="badge">Allowed IDs: â€“</span>
        <span id="dbg-ev" class="badge">Events: â€“</span>
        <span id="dbg-errors" class="badge">Errors: 0</span>
      </div>
      <h3 class="small">Live state (sorted by dwell time)</h3>
      <table id="stateTable"><thead>
        <tr><th>ID</th><th>Label</th><th>Zone IDs</th><th>Zone Labels</th><th>Lat</th><th>Lon</th><th>Speed</th><th>Updated</th><th>Dwell</th></tr>
      </thead><tbody></tbody></table>
      <h3 class="small">Log</h3>
      <pre id="dbg-log">Bootingâ€¦</pre>
    </details>
  </main>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env">
    const API = { eu: "https://api.eu.navixy.com/v2", us: "https://api.us.navixy.com/v2" };
    const TRACKER_GROUP_NAME = "Onelogix Linehaul Trucks";
    const DWELL_THRESHOLD_MIN = 30;

    const dbg = (m)=>{const el=document.getElementById("dbg-log"); el.textContent=(el.textContent?el.textContent+"\n":"")+m; console.log(m);};
    function setBadge(id,txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
    function hhmm(mins){ const h=Math.floor(mins/60), m=mins%60; return h?`${h}h ${m}m`:`${m}m`; }

    /* ==== MOCK fetch ==== */
    async function fetchZones(){ return [{id:1,label:"Depot"},{id:2,label:"Highway"}]; }
    async function fetchTrackers(){ return [{id:101,label:"Truck A"},{id:102,label:"Truck B"}]; }
    function buildZonesMap(){ return {"Depot":[{tid:101,mins:80}], "Highway":[]}; }

    function renderCards(zonesMap, trackers, allZones){
      const grid=document.getElementById("grid"); grid.innerHTML="";
      allZones.forEach(zone=>{
        const name=zone.label||`Zone ${zone.id}`;
        const list=(zonesMap[name]||[]).sort((a,b)=>b.mins-a.mins);
        const div=document.createElement("div");
        div.className="card";
        div.innerHTML=`<h3>${name} (${list.length})</h3>`;
        if(!list.length){
          const empty=document.createElement("div");
          empty.className="truck"; empty.style.color="var(--muted)";
          empty.textContent="No trucks inside";
          div.appendChild(empty);
        } else {
          list.forEach(t=>{
            const meta=trackers.find(x=>String(x.id)===String(t.tid));
            const label=(meta&&(meta.label||meta.name))||`#${t.tid}`;
            const cls=t.mins>=DWELL_THRESHOLD_MIN?"warn":"ok";
            const row=document.createElement("div");
            row.className=`truck ${cls}`;
            row.innerHTML=`<span>${label}</span><span>${hhmm(t.mins)}</span>`;
            div.appendChild(row);
          });
        }
        grid.appendChild(div);
      });
    }

    function renderStateTable(zonesMap, trackers){
      const tb=document.querySelector("#stateTable tbody"); tb.innerHTML="";
      const rows=[];
      Object.entries(zonesMap).forEach(([zone,list])=>{
        list.forEach(t=>{
          const meta=trackers.find(x=>String(x.id)===String(t.tid));
          rows.push({
            tid:t.tid,
            label:(meta&&meta.label)||`#${t.tid}`,
            zone:zone,
            mins:t.mins,
            lat:(Math.random()*2-1).toFixed(5), // mock lat
            lon:(Math.random()*2+25).toFixed(5), // mock lon
            speed:Math.floor(Math.random()*80),
            updated:new Date().toISOString().slice(0,19).replace("T"," ")
          });
        });
      });
      rows.sort((a,b)=>b.mins-a.mins);
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        if(r.mins>=DWELL_THRESHOLD_MIN) tr.classList.add("warn");
        tr.innerHTML=`<td>${r.tid}</td><td>${r.label}</td><td>${r.zone}</td><td>${r.zone}</td>
          <td>${r.lat}</td><td>${r.lon}</td><td>${r.speed}</td><td>${r.updated}</td><td>${hhmm(r.mins)}</td>`;
        tb.appendChild(tr);
      });
      if(!rows.length) tb.innerHTML=`<tr><td colspan="9" class="small">No tracker state</td></tr>`;
    }

    async function runOnce(){
      dbg("ðŸš€ Run sequence");
      const trackers=await fetchTrackers();
      const zones=await fetchZones();
      const zonesMap=buildZonesMap();
      renderCards(zonesMap,trackers,zones);
      renderStateTable(zonesMap,trackers);
      setBadge("updated","Updated "+new Date().toLocaleTimeString());
    }

    document.getElementById("testBtn").addEventListener("click", runOnce);
    runOnce();
  </script>
</body>
</html>
